//- views/movie-selection.jade
html
  head
    title 选择看过的电影
    link(rel="stylesheet", href="/css/movie-selection.css")
  body
    .movie-selection-container
      .header
        h1 欢迎用户: #{username}
        p 请选择您看过的电影（已选择:
          span(id="selectedCount") 0
          | / #{minSelectionRequired} 部）

      .search-section
        input.search-input(type="text", id="searchInput", placeholder="搜索电影...")
        button.search-button(type="button", onclick="filterMovies()") 搜索

      form(id="movieSelectionForm", action='/rate-movies', method='post')
        input(type='hidden', name='userid', value=userid)
        input(type='hidden', name='selectedMovieIds', id="selectedMovieIds", value='')

        .movies-grid(id="moviesGrid")
          - var currentBatch = movieBatches[currentBatchIndex] || []
          - for(var i = 0; i < currentBatch.length; i++)
            .movie-card(
              onclick="toggleMovieSelection(this, '" + currentBatch[i].movieid + "')",
              data-movie-id=currentBatch[i].movieid
            )
              .movie-title #{currentBatch[i].moviename}
              input(
                type='checkbox',
                name='selectedMovies',
                value=currentBatch[i].movieid,
                id=`movie-${currentBatch[i].movieid}`,
                style="display: none;"
              )

        .controls-section
          .batch-controls
            button.control-button.next-batch-button(
              type="button",
              onclick="loadNextBatch()"
            ) 换一批 (#{currentBatchIndex + 1}/#{totalBatches})

          .selection-info
            .progress-bar
              .progress-fill(id="progressFill", style="width: 0%")
            p 已选择
              span(id="selectedCountText") 0
              | 部电影（至少选择 #{minSelectionRequired} 部才能继续）

            button.control-button.proceed-button(
              type="submit",
              id="proceedButton",
              disabled=true
            ) 进入评分页面

    script.
      // 全局变量
      let currentBatchIndex = #{currentBatchIndex};
      const totalBatches = #{totalBatches};
      const minSelectionRequired = #{minSelectionRequired};
      const movieBatches = !{JSON.stringify(movieBatches)};
      let selectedMovies = new Set();

      // 切换电影选择
      function toggleMovieSelection(cardElement, movieId) {
        const checkbox = cardElement.querySelector('input[type="checkbox"]');

        if (selectedMovies.has(movieId)) {
          selectedMovies.delete(movieId);
          cardElement.classList.remove('selected');
          checkbox.checked = false;
        } else {
          selectedMovies.add(movieId);
          cardElement.classList.add('selected');
          checkbox.checked = true;
        }

        updateSelectionInfo();
      }

      // 更新选择信息
      function updateSelectionInfo() {
        const selectedCount = selectedMovies.size;
        const selectedCountElement = document.getElementById('selectedCount');
        const selectedCountTextElement = document.getElementById('selectedCountText');
        const proceedButton = document.getElementById('proceedButton');
        const progressFill = document.getElementById('progressFill');
        const selectedMovieIdsInput = document.getElementById('selectedMovieIds');

        selectedCountElement.textContent = selectedCount;
        selectedCountTextElement.textContent = selectedCount;

        const progressPercentage = Math.min((selectedCount / minSelectionRequired) * 100, 100);
        progressFill.style.width = progressPercentage + '%';

        proceedButton.disabled = selectedCount < minSelectionRequired;
        selectedMovieIdsInput.value = Array.from(selectedMovies).join(',');

        if (selectedCount >= minSelectionRequired) {
          progressFill.style.backgroundColor = '#28a745';
        } else {
          progressFill.style.backgroundColor = '#ffc107';
        }
      }

      // 加载下一批电影
      function loadNextBatch() {
        currentBatchIndex = (currentBatchIndex + 1) % totalBatches;
        renderCurrentBatch();
      }

      // 渲染当前批次的电影
      function renderCurrentBatch() {
        const moviesGrid = document.getElementById('moviesGrid');
        const currentBatch = movieBatches[currentBatchIndex] || [];

        moviesGrid.innerHTML = '';

        currentBatch.forEach(movie => {
          const isSelected = selectedMovies.has(movie.movieid);
          const movieCard = document.createElement('div');
          movieCard.className = `movie-card ${isSelected ? 'selected' : ''}`;
          movieCard.setAttribute('data-movie-id', movie.movieid);
          movieCard.onclick = () => toggleMovieSelection(movieCard, movie.movieid);

          movieCard.innerHTML = `
            <div class="movie-title">${movie.moviename}</div>
            <input type="checkbox" name="selectedMovies" value="${movie.movieid}" ${isSelected ? 'checked' : ''} style="display: none;">
          `;

          moviesGrid.appendChild(movieCard);
        });

        const nextBatchButton = document.querySelector('.next-batch-button');
        nextBatchButton.textContent = `换一批 (${currentBatchIndex + 1}/${totalBatches})`;
      }

      // 搜索过滤电影
      function filterMovies() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        const movieCards = document.querySelectorAll('.movie-card');

        movieCards.forEach(card => {
          const movieTitle = card.querySelector('.movie-title').textContent.toLowerCase();
          if (movieTitle.includes(searchTerm)) {
            card.style.display = '';
          } else {
            card.style.display = 'none';
          }
        });
      }

      // 初始化
      document.addEventListener('DOMContentLoaded', function() {
        updateSelectionInfo();
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            filterMovies();
          }
        });
      });