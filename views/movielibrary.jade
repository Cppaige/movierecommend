extends layout

block content
  .page-container
    // 页面头部
    .page-header
      h1
        i.fas.fa-film
        | 电影库
      p.subtitle 共 #{totalMovies} 部精彩电影，等你来发现

    // 筛选和排序栏
    .controls-bar
      .controls-group
        span.label 排序方式：
        a.control-btn(href=`/movielibrary?sort=movieid&order=${orderBy === 'DESC' ? 'desc' : 'asc'}`, class=sortBy === 'movieid' ? 'active' : '')
          i.fas.fa-list
          | 默认
        a.control-btn(href=`/movielibrary?sort=averating&order=desc`, class=sortBy === 'averating' ? 'active' : '')
          i.fas.fa-star
          | 评分最高
        a.control-btn(href=`/movielibrary?sort=numrating&order=desc`, class=sortBy === 'numrating' ? 'active' : '')
          i.fas.fa-fire
          | 最热门
        a.control-btn(href=`/movielibrary?sort=releasetime&order=desc`, class=sortBy === 'releasetime' ? 'active' : '')
          i.fas.fa-calendar
          | 最新上映

    // 电影网格
    .movies-grid
      each movie in movies
        .movie-card(data-movie-id=movie.id)
          a(href=`/movie/${movie.id}`, style='display: block; text-decoration: none; color: inherit;')
            .card-top
              img(src=movie.poster, alt=movie.title, onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'")
              .card-overlay
                .overlay-content
                  if movie.rating > 0
                    .overlay-rating
                      i.fas.fa-star
                      | #{movie.rating}
                  .overlay-action 查看详情
            .card-content
              h3 #{movie.title}
              .meta
                if movie.genres.length > 0
                  span.genre #{movie.genres[0]}
                span.rating
                  i.fas.fa-star
                  | #{movie.rating}
              if movie.releaseDate
                p.year
                  i.fas.fa-calendar-alt
                  |  #{movie.releaseDate}

          .card-actions
            button.action-btn.favorite-btn(onclick=`toggleFavorite(${movie.id}, this); event.stopPropagation();`, title='收藏')
              i.far.fa-heart

    // 分页控件
    if totalPages > 1
      .pagination
        if currentPage > 1
          a.page-btn(href=`/movielibrary?page=${currentPage - 1}&sort=${sortBy}&order=${order}`)
            i.fas.fa-chevron-left
            | 上一页

        // 显示页码
        - var startPage = Math.max(1, currentPage - 2);
        - var endPage = Math.min(totalPages, currentPage + 2);

        if startPage > 1
          a.page-btn(href=`/movielibrary?page=1&sort=${sortBy}&order=${order}`) 1
          if startPage > 2
            span.page-ellipsis ...

        - for (var i = startPage; i <= endPage; i++)
          a.page-btn(href=`/movielibrary?page=${i}&sort=${sortBy}&order=${order}`, class=i === currentPage ? 'active' : '') #{i}

        if endPage < totalPages
          if endPage < totalPages - 1
            span.page-ellipsis ...
          a.page-btn(href=`/movielibrary?page=${totalPages}&sort=${sortBy}&order=${order}`) #{totalPages}

        if currentPage < totalPages
          a.page-btn(href=`/movielibrary?page=${currentPage + 1}&sort=${sortBy}&order=${order}`)
            | 下一页
            i.fas.fa-chevron-right

block extraJS
  script(src='/js/favorites.js')
  script.
    // 页面加载时检查收藏状态
    document.addEventListener('DOMContentLoaded', function() {
      const movieCards = document.querySelectorAll('.movie-card');
      const movieIds = Array.from(movieCards).map(card => card.dataset.movieId).filter(id => id);
      if (movieIds.length > 0 && window.appState.isLogin) {
        checkFavoritesStatus(movieIds);
      }
    });
